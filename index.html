<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVMH Voice-to-Tag | AI Cleaning</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px
        }

        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 1px solid #222
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px
        }

        h1 span {
            color: #d4af37
        }

        .tagline {
            color: #888;
            font-size: .9rem;
            text-transform: uppercase;
            letter-spacing: 2px
        }

        .upload-area {
            max-width: 500px;
            margin: 60px auto;
            padding: 60px 40px;
            background: rgba(255, 255, 255, .03);
            border: 2px dashed #333;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all .3s
        }

        .upload-area:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, .05)
        }

        .upload-area h2 {
            margin-bottom: 10px;
            font-size: 1.3rem
        }

        .upload-area p {
            color: #888;
            margin-bottom: 20px
        }

        .btn {
            display: inline-block;
            padding: 14px 32px;
            background: linear-gradient(135deg, #d4af37, #b8960c);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, .3)
        }

        .results {
            display: none
        }

        .results.active {
            display: block
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px
        }

        @media(max-width:900px) {
            .stats {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, .03);
            border: 1px solid #222;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px
        }

        .stat-icon {
            font-size: 2rem
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #d4af37
        }

        .stat-label {
            color: #888;
            font-size: .85rem
        }

        .stat-card.warning .stat-value {
            color: #ef4444
        }

        .stat-card.success .stat-value {
            color: #10b981
        }

        .section-box {
            background: rgba(255, 255, 255, .03);
            border: 1px solid #222;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px
        }

        .section-box h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .section-box.danger {
            border-color: #ef4444;
            background: rgba(239, 68, 68, .05)
        }

        .section-box.danger h3 {
            color: #ef4444
        }

        .section-box.ai {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, .05)
        }

        .section-box.ai h3 {
            color: #8b5cf6
        }

        .rgpd-bad-list {
            max-height: 180px;
            overflow-y: auto
        }

        .rgpd-bad-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, .3);
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #ef4444;
            font-size: .85rem
        }

        .rgpd-bad-item .id {
            font-weight: 600;
            color: #d4af37;
            min-width: 70px
        }

        .rgpd-bad-item .cat {
            background: #ef4444;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: .7rem
        }

        .person-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            max-height: 550px;
            overflow-y: auto
        }

        @media(max-width:500px) {
            .person-grid {
                grid-template-columns: 1fr
            }
        }

        .person-card {
            background: rgba(255, 255, 255, .02);
            border: 1px solid #222;
            border-radius: 12px;
            padding: 16px
        }

        .person-card:hover {
            border-color: #d4af37
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222
        }

        .person-id {
            font-weight: 700;
            font-size: 1.1rem;
            color: #d4af37
        }

        .person-meta {
            display: flex;
            gap: 8px
        }

        .person-meta span {
            background: rgba(255, 255, 255, .1);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: .7rem;
            color: #aaa
        }

        .tag-section {
            margin-bottom: 8px
        }

        .tag-section-title {
            font-size: .68rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 1px
        }

        .tag-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px
        }

        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: .7rem
        }

        .tag.profession {
            background: rgba(59, 130, 246, .15);
            color: #60a5fa
        }

        .tag.product {
            background: rgba(212, 175, 55, .15);
            color: #d4af37
        }

        .tag.pref {
            background: rgba(16, 185, 129, .15);
            color: #34d399
        }

        .tag.style {
            background: rgba(168, 85, 247, .15);
            color: #c084fc
        }

        .tag.lifestyle {
            background: rgba(236, 72, 153, .15);
            color: #f472b6
        }

        .tag.occasion {
            background: rgba(251, 146, 60, .15);
            color: #fb923c
        }

        .tag.budget {
            background: rgba(234, 179, 8, .15);
            color: #facc15
        }

        .tag.service {
            background: rgba(99, 102, 241, .15);
            color: #a5b4fc
        }

        .tag.network {
            background: rgba(20, 184, 166, .15);
            color: #2dd4bf
        }

        .no-tags {
            color: #555;
            font-style: italic;
            font-size: .85rem
        }

        .search-box {
            margin-bottom: 20px
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: .95rem
        }

        .search-input:focus {
            outline: none;
            border-color: #d4af37
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, .3);
            border-radius: 8px;
            font-size: .7rem
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #888
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%
        }

        .export-section {
            text-align: center;
            padding: 30px 0
        }

        .export-btns {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid #333;
            border-radius: 10px;
            cursor: pointer
        }

        .export-btn:hover {
            border-color: #d4af37
        }

        .export-btn .icon {
            font-size: 1.3rem
        }

        .export-btn strong {
            color: #fff;
            font-size: .9rem
        }

        .export-btn small {
            color: #888;
            font-size: .75rem
        }

        .compare-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px
        }

        @media(max-width:700px) {
            .compare-box {
                grid-template-columns: 1fr
            }
        }

        .compare-panel {
            background: rgba(0, 0, 0, .3);
            border-radius: 8px;
            padding: 15px
        }

        .compare-panel h4 {
            margin-bottom: 10px;
            font-size: .9rem;
            color: #888
        }

        .compare-panel pre {
            white-space: pre-wrap;
            font-size: .75rem;
            max-height: 120px;
            overflow-y: auto;
            color: #ccc;
            line-height: 1.4
        }

        .compare-panel.before {
            border-left: 3px solid #ef4444
        }

        .compare-panel.after {
            border-left: 3px solid #10b981
        }

        footer {
            text-align: center;
            padding: 30px;
            border-top: 1px solid #222;
            margin-top: 40px;
            color: #666;
            font-size: .85rem
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column
        }

        .loading.active {
            display: flex
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .loading p {
            margin-top: 20px;
            color: #888
        }

        .loading .progress {
            margin-top: 10px;
            color: #8b5cf6;
            font-weight: 600
        }
    </style>
</head>

<body>
    <header>
        <h1>‚óÜ LVMH <span>Voice-to-Tag</span></h1>
        <p class="tagline">ü§ñ AI-Powered Cleaning (Mistral)</p>
    </header>
    <div class="container">
        <div class="upload-area" id="uploadArea">
            <h2>üì§ Importer CSV</h2>
            <p>Nettoyage par IA Mistral</p><input type="file" id="fileInput" accept=".csv" hidden><button class="btn"
                id="selectBtn">S√©lectionner</button>
        </div>
        <div class="results" id="results">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon">üë§</div>
                    <div>
                        <div class="stat-value" id="statNotes">0</div>
                        <div class="stat-label">Clients</div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">üè∑Ô∏è</div>
                    <div>
                        <div class="stat-value" id="statTags">0</div>
                        <div class="stat-label">Tags</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ü§ñ</div>
                    <div>
                        <div class="stat-value" id="statAI">0</div>
                        <div class="stat-label">Nettoy√©s par IA</div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">üö´</div>
                    <div>
                        <div class="stat-value" id="statRgpd">0</div>
                        <div class="stat-label">RGPD</div>
                    </div>
                </div>
            </div>
            <div class="section-box ai">
                <h3>ü§ñ Nettoyage IA Mistral</h3>
                <p style="color:#aaa;font-size:.85rem">Chaque transcription a √©t√© nettoy√©e par l'IA pour supprimer les
                    h√©sitations, fillers et expressions vides tout en pr√©servant le contenu m√©tier.</p>
            </div>
            <div class="section-box">
                <h3>üîç Avant / Apr√®s IA</h3>
                <div class="compare-box">
                    <div class="compare-panel before">
                        <h4>‚ùå Brut</h4>
                        <pre id="beforeText">...</pre>
                    </div>
                    <div class="compare-panel after">
                        <h4>‚úÖ Nettoy√© par IA</h4>
                        <pre id="afterText">...</pre>
                    </div>
                </div>
            </div>
            <div class="section-box danger" id="rgpdSection">
                <h3>üö´ RGPD Non Conformes</h3>
                <div class="rgpd-bad-list" id="rgpdBadList"></div>
            </div>
            <div class="section-box">
                <h3>üè∑Ô∏è Fiches Clients</h3>
                <div class="legend">
                    <div class="legend-item"><span class="legend-dot" style="background:#60a5fa"></span>Profession</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#d4af37"></span>Produit</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#34d399"></span>Pr√©f√©rence</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#c084fc"></span>Style</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#f472b6"></span>Lifestyle</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#fb923c"></span>Occasion</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#facc15"></span>Budget</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#a5b4fc"></span>Service</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#2dd4bf"></span>R√©seau</div>
                </div>
                <div class="search-box"><input type="text" class="search-input" id="personSearch"
                        placeholder="üîç Rechercher..."></div>
                <div class="person-grid" id="personGrid"></div>
            </div>
            <div class="export-section">
                <div class="export-btns">
                    <button class="export-btn" id="exportCsv"><span
                            class="icon">üìä</span><span><strong>CSV</strong><br><small>Nettoy√©
                                IA</small></span></button>
                    <button class="export-btn" id="exportJson"><span
                            class="icon">üè∑Ô∏è</span><span><strong>JSON</strong><br><small>Tags</small></span></button>
                </div>
            </div>
        </div>
    </div>
    <footer>ü§ñ Mistral AI Cleaning</footer>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingMsg">Nettoyage par IA...</p>
        <div class="progress" id="loadingProgress">0/0</div>
    </div>
    <script src="tagger.js"></script>
    <script>
        const MISTRAL_API_KEY = 'jdktG6GMjxjSz769BBOpuO7Yr7nD7evc';
        const MISTRAL_URL = 'https://api.mistral.ai/v1/chat/completions';

        const CLEANING_PROMPT = `Tu es un expert RGPD pour le retail luxe. Tu dois nettoyer ET s√©curiser les transcriptions.

√âTAPE 1 - NETTOYER (supprimer uniquement) :
- H√©sitations : euh, hum, uh, um, eh, ah, oh, hmm, bah, ben, pues, ehm, √§h, √§hm
- Fillers : genre, like, tipo, basically, en fait, du coup, tu vois, you know, quoi, right, vale, ok, genau, en quelque sorte, plus ou moins
- R√©p√©titions inutiles

√âTAPE 2 - MASQUER LES DONN√âES ULTRA-SENSIBLES (remplacer par le masque) :
- Num√©ros de carte bancaire (16 chiffres) ‚Üí [CARTE-MASQU√âE]
- Dates expiration cartes (MM/YY) ‚Üí [EXP-MASQU√âE]
- Codes CVC/CVV (3 chiffres apr√®s carte) ‚Üí [CVC-MASQU√â]
- IBAN/num√©ros de compte bancaire ‚Üí [IBAN-MASQU√â]
- Codes d'acc√®s/porte/digicode ‚Üí [CODE-MASQU√â]
- Num√©ros s√©curit√© sociale/SSN ‚Üí [SSN-MASQU√â]
- Num√©ros passeport/DNI/carte identit√© ‚Üí [ID-MASQU√â]
- Adresses postales compl√®tes (rue + code postal + ville) ‚Üí [ADRESSE-MASQU√âE]
- Num√©ros de t√©l√©phone ‚Üí [TEL-MASQU√â]
- Adresses email ‚Üí [EMAIL-MASQU√â]
- Mots de passe mentionn√©s ‚Üí [MDP-MASQU√â]

GARDER ABSOLUMENT (donn√©es business justifiables) :
- Noms, pr√©noms, titres (Mme, Mr, Sig., Frau)
- Professions, fonctions
- √Çges
- Budgets et montants
- Pr√©f√©rences produits, couleurs, styles
- Allergies (nickel, latex, gluten) ‚Üí s√©curit√© client
- R√©gimes alimentaires ‚Üí service √©v√©nements
- Dates d'√©v√©nements (anniversaires, mariages)
- Historique client (depuis 2019, etc.)

FORMAT DE R√âPONSE OBLIGATOIRE (2 lignes exactement) :
RGPD_COUNT: [nombre de donn√©es masqu√©es]
TEXT: [texte nettoy√© avec les masques appliqu√©s]

Texte √† traiter :
`;

        // Fallback RGPD patterns (si Mistral √©choue)
        const RGPD_FALLBACK = {
            'Carte': [/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g],
            'IBAN': [/\b[A-Z]{2}\d{2}[\s]?[A-Z0-9]{4}[\s]?[A-Z0-9]{4}[\s]?[A-Z0-9]{4}[\s]?[A-Z0-9]{0,4}/gi],
            'SSN': [/\b\d{3}[-]?\d{2}[-]?\d{4}\b/g],
            'Tel': [/\b(\+\d{1,3}[\s]?)?\d{2,4}[\s]?\d{2,4}[\s]?\d{2,4}[\s]?\d{0,4}\b/g],
            'Email': [/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g],
            'Code': [/\bcode\s*(porte|acc√®s|digicode)?\s*:?\s*\d{4,6}\b/gi, /\bdigicode\s*:?\s*\d{4,6}\b/gi]
        };

        // TAGS managed in tagger.js


        let DATA = [], RGPD_BAD = [], STATS = { notes: 0, tags: 0, ai: 0, rgpd: 0 };
        const $ = id => document.getElementById(id);

        $('selectBtn').onclick = () => $('fileInput').click();
        $('uploadArea').onclick = e => { if (e.target.id !== 'selectBtn') $('fileInput').click(); };

        $('fileInput').onchange = async e => {
            const file = e.target.files[0]; if (!file) return;
            $('loading').classList.add('active');
            $('loadingMsg').textContent = 'Lecture du fichier...';
            try {
                const text = await file.text();
                const rows = parseCSV(text);
                DATA = await processDataWithAI(rows);
                extractTags();
                $('loading').classList.remove('active');
                showResults();
            } catch (err) { $('loading').classList.remove('active'); alert('Erreur: ' + err.message); console.error(err); }
        };

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const vals = []; let curr = '', inQ = false;
                for (const ch of lines[i]) {
                    if (ch === '"') inQ = !inQ;
                    else if (ch === ',' && !inQ) { vals.push(curr.trim()); curr = ''; }
                    else curr += ch;
                }
                vals.push(curr.trim());
                if (vals.length >= headers.length) { const row = {}; headers.forEach((h, j) => row[h] = vals[j] || ''); rows.push(row); }
            }
            return rows;
        }

        async function cleanWithMistral(text) {
            try {
                const response = await fetch(MISTRAL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MISTRAL_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'mistral-small-latest',
                        messages: [{ role: 'user', content: CLEANING_PROMPT + text }],
                        max_tokens: 1500,
                        temperature: 0.1
                    })
                });
                if (!response.ok) throw new Error('API Error: ' + response.status);
                const data = await response.json();
                const result = data.choices[0].message.content.trim();

                // Parse response format: RGPD_COUNT: X\nTEXT: ...
                const rgpdMatch = result.match(/RGPD_COUNT:\s*(\d+)/i);
                const textMatch = result.match(/TEXT:\s*([\s\S]*)/i);

                if (rgpdMatch && textMatch) {
                    return {
                        text: textMatch[1].trim(),
                        rgpdCount: parseInt(rgpdMatch[1], 10),
                        rgpdItems: []
                    };
                }

                // Fallback: Mistral didn't follow format, use regex fallback
                let cleanText = result;
                let rgpdCount = 0;
                const rgpdItems = [];

                Object.entries(RGPD_FALLBACK).forEach(([cat, patterns]) => {
                    patterns.forEach(re => {
                        const matches = cleanText.match(re);
                        if (matches) {
                            matches.forEach(m => {
                                rgpdItems.push({ cat, value: m });
                                rgpdCount++;
                            });
                            cleanText = cleanText.replace(re, `[${cat.toUpperCase()}-MASQU√â]`);
                        }
                    });
                });

                return { text: cleanText, rgpdCount, rgpdItems };
            } catch (err) {
                console.error('Mistral error:', err);
                // Fallback local cleaning with regex
                let cleanText = text;
                let rgpdCount = 0;
                const rgpdItems = [];

                Object.entries(RGPD_FALLBACK).forEach(([cat, patterns]) => {
                    patterns.forEach(re => {
                        const matches = cleanText.match(re);
                        if (matches) {
                            matches.forEach(m => {
                                rgpdItems.push({ cat, value: m });
                                rgpdCount++;
                            });
                            cleanText = cleanText.replace(re, `[${cat.toUpperCase()}-MASQU√â]`);
                        }
                    });
                });

                return { text: cleanText, rgpdCount, rgpdItems };
            }
        }

        async function processDataWithAI(rows) {
            STATS = { notes: 0, tags: 0, ai: 0, rgpd: 0 };
            RGPD_BAD = [];
            const results = [];

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const orig = row.Transcription || row.transcription || '';
                const id = row.ID || 'N/A', date = row.Date || '', lang = (row.Language || row.Langue || 'FR').toUpperCase();

                $('loadingMsg').textContent = 'ü§ñ Nettoyage + RGPD IA...';
                $('loadingProgress').textContent = `${i + 1}/${rows.length}`;

                // Clean with Mistral AI (includes RGPD detection)
                const result = await cleanWithMistral(orig);
                STATS.ai++;

                // Count RGPD issues
                if (result.rgpdCount > 0) {
                    STATS.rgpd += result.rgpdCount;
                    // Extract masked items from text
                    const masks = result.text.match(/\[[A-Z]+-MASQU[√âE]+\]/gi) || [];
                    masks.forEach(m => {
                        RGPD_BAD.push({ id, cat: m.replace(/[\[\]]/g, ''), w: 'Donn√©e masqu√©e' });
                    });
                }

                const clean = result.text.replace(/\s+/g, ' ').trim();
                STATS.notes++;
                results.push({ id, date, lang, orig, clean, tags: [] });

                // Small delay to avoid rate limiting
                if (i < rows.length - 1) await new Promise(r => setTimeout(r, 300));
            }
            return results;
        }

        function extractTags() {
            DATA.forEach(row => {
                const extracted = Tagger.extractTags(row.clean || row.orig);
                row.tags = extracted;
                STATS.tags += extracted.length;
            });
        }

        function showResults() {
            $('uploadArea').style.display = 'none';
            $('results').classList.add('active');
            $('statNotes').textContent = STATS.notes;
            $('statTags').textContent = STATS.tags;
            $('statAI').textContent = STATS.ai;
            $('statRgpd').textContent = STATS.rgpd;

            if (DATA.length > 0) {
                $('beforeText').textContent = DATA[0].orig.substring(0, 350) + '...';
                $('afterText').textContent = DATA[0].clean.substring(0, 350) + '...';
            }

            const bl = $('rgpdBadList');
            if (RGPD_BAD.length === 0) $('rgpdSection').style.display = 'none';
            else bl.innerHTML = RGPD_BAD.map(i => `<div class="rgpd-bad-item"><span class="id">${i.id}</span><span class="cat">${i.cat}</span>${i.w}</div>`).join('');

            renderGrid();
            $('personSearch').oninput = e => renderGrid(e.target.value);
            $('exportCsv').onclick = exportCSV;
            $('exportJson').onclick = exportJSON;
        }

        function renderGrid(filter = '') {
            const g = $('personGrid'); g.innerHTML = '';
            const f = filter.toLowerCase();
            DATA.filter(p => !f || p.id.toLowerCase().includes(f) || p.tags.some(t => t.tag.toLowerCase().includes(f)) || p.clean.toLowerCase().includes(f))
                .forEach(p => {
                    const cats = {};
                    p.tags.forEach(t => { if (!cats[t.category]) cats[t.category] = []; cats[t.category].push(t.tag); });

                    const names = {
                        'PROFIL_GENRE': 'üë§ Genre',
                        'PROFIL_G√âN√âRATION': 'üë∂/üë¥ G√©n√©ration',
                        'PROFIL_STATUS': 'üíé Status',
                        'PROFIL_LANGUE': 'üó£Ô∏è Langue',
                        'PROFIL_INFLUENCE': '‚ú® Influence',
                        'PROFIL_DIGITAL': 'üì± Digital',
                        'PROFESSION_SANT√â': '‚öïÔ∏è Sant√©',
                        'PROFESSION_FINANCE': 'üí∞ Finance',
                        'PROFESSION_L√âGAL': '‚öñÔ∏è L√©gal',
                        'PROFESSION_CR√âATIF': 'üé® Cr√©atif',
                        'PROFESSION_BUSINESS': 'üíº Business',
                        'PROFESSION_PUBLIC': 'üèõÔ∏è Public',
                        'PASSION_CERCLES': '‚≠ï Cercles',
                        'PASSION_COLLECTION': 'üñºÔ∏è Collection',
                        'PASSION_SPORT': 'üéæ Sport',
                        'PASSION_CULTURE': 'üé≠ Culture',
                        'VALEURS_√âTHIQUE': 'üå± Valeurs',
                        'VOYAGE_TYPE': '‚úàÔ∏è Type Voyage',
                        'VOYAGE_DESTINATION': 'üìç Destination',
                        'INTENTION_DESTINATAIRE': 'üéÅ Destinataire',
                        'INTENTION_OCCASION': 'üéâ Occasion',
                        'INTENTION_STYLE': 'üëó Le Style',
                        'S√âCURIT√â_RISQUE': '‚ö†Ô∏è Risque Vital',
                        'S√âCURIT√â_ALIM': 'üçΩÔ∏è R√©gime',
                        'S√âCURIT√â_CONFORT': 'üõãÔ∏è Confort',
                        'UNIVERS_LV': 'üëú Univers LV',
                        'HISTO_MARO_FEMME': 'üëú Maro Femme',
                        'HISTO_MARO_HOMME': 'üíº Maro Homme',
                        'HISTO_VOYAGE': 'üß≥ Voyage (Histo)',
                        'HISTO_SIZING': 'üìè Sizing',
                        'HISTO_STYLE': 'üë† Style Histo',
                        'OPPORTUNIT√âS_MANQU√âES': '‚ùå Opportunit√©s',
                        'ACTION_CRM': '‚ö° Action CRM'
                    };
                    let html = `<div class="person-header"><span class="person-id">${p.id}</span><div class="person-meta"><span>${p.lang}</span><span>${p.date}</span><span>${p.tags.length} tags</span></div></div>`;
                    if (Object.keys(cats).length === 0) html += '<div class="no-tags">Aucun tag</div>';
                    else Object.entries(cats).forEach(([c, tags]) => { html += `<div class="tag-section"><div class="tag-section-title">${names[c] || c}</div><div class="tag-row">${tags.map(t => `<span class="tag ${c}">${t}</span>`).join('')}</div></div>`; });
                    const card = document.createElement('div'); card.className = 'person-card'; card.innerHTML = html; g.appendChild(card);
                });
        }

        function exportCSV() { const l = ['ID,Date,Langue,Transcription_AI_Clean,Tags']; DATA.forEach(r => l.push([r.id, r.date, r.lang, '"' + r.clean.replace(/"/g, '""') + '"', '"' + r.tags.map(t => t.tag).join('|') + '"'].join(','))); dl(l.join('\n'), 'lvmh_ai_cleaned.csv', 'text/csv'); }
        function exportJSON() { dl(JSON.stringify(DATA.map(r => ({ id: r.id, date: r.date, lang: r.lang, clean: r.clean, tags: r.tags })), null, 2), 'lvmh_ai_tags.json', 'application/json'); }
        function dl(c, n, t) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], { type: t })); a.download = n; a.click(); }
    </script>
</body>

</html>